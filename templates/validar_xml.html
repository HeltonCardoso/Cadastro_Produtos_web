{% extends 'base.html' %}
{% block title %}Validar XML da NF-e{% endblock %}

{% block content %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    Fa√ßa o upload do XML da NF-e/NFC-e autorizada para validar chave, ambiente, emitente, destinat√°rio e status.
</div>

<h2 class="mb-4">XML NF-e</h2>

<form id="xmlForm" method="POST" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="arquivo_xml" class="form-label">Arquivo XML da NF-e:</label>
    <input type="file" class="form-control" id="arquivo_xml" name="arquivo_xml" accept=".xml" required>
  </div>
  <div class="d-flex align-items-center gap-2 mt-3">
    <button id="btnValidar" type="submit" class="btn btn-primary">VALIDAR XML</button>
  </div>
</form>

<!-- √Årea de Resultado -->
<div class="mt-4">
  <h5>Resultado:</h5>
  <div id="resultadoContainer" class="bg-light p-3 rounded" style="min-height: 150px; font-size: 1.05em;">
    <span class="text-muted">Aguardando upload...</span>
  </div>
</div>

<script>
document.getElementById('xmlForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const btn = document.getElementById('btnValidar');
  const container = document.getElementById('resultadoContainer');
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Validando...';
  container.innerHTML = '<span class="text-muted">Processando XML...</span>';

  try {
    const formData = new FormData(this);
    const response = await fetch('/validar-xml', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.erro || 'Erro no processamento');

    if (data.sucesso) {
      const d = data.dados;
      container.innerHTML = `
        <h6 class="mt-2">üìÑ Dados da Nota</h6>
        <ul>
          <li><b>Chave:</b> ${d.chave || 'N/A'}</li>
          <li><b>Modelo:</b> ${d.modelo || 'N/A'}</li>
          <li><b>N√∫mero:</b> ${d.numero || 'N/A'} - <b>S√©rie:</b> ${d.serie || 'N/A'}</li>
          <li><b>Ambiente:</b> ${d.ambiente || 'N/A'}</li>
          <li><b>Status:</b> ${d.autorizada ? '<span class="text-success">Autorizada ‚úÖ</span>' : '<span class="text-danger">N√£o autorizada ‚ùå</span>'}</li>
          <li><b>QRCode:</b> ${d.qrcode || 'N/A'}</li>
        </ul>

        <h6 class="mt-3">üè¢ Emitente</h6>
        <ul>
          <li><b>Nome:</b> ${d.emitente?.nome || 'N/A'}</li>
          <li><b>CNPJ/CPF:</b> ${d.emitente?.cnpj || d.emitente?.cpf || 'N/A'}</li>
        </ul>

        <h6 class="mt-3">üôç‚Äç‚ôÇÔ∏è Destinat√°rio</h6>
        <ul>
          <li><b>Nome:</b> ${d.destinatario?.nome || 'N/A'}</li>
          <li><b>CNPJ/CPF:</b> ${d.destinatario?.cnpj || d.destinatario?.cpf || 'N/A'}</li>
          <li><b>Endere√ßo:</b> 
            ${d.destinatario?.endereco?.logradouro || ''}, 
            ${d.destinatario?.endereco?.numero || ''} - 
            ${d.destinatario?.endereco?.bairro || ''}, 
            ${d.destinatario?.endereco?.municipio || ''}/${d.destinatario?.endereco?.uf || ''} 
            CEP: ${d.destinatario?.endereco?.cep || ''}
          </li>
        </ul>
      `;
    } else {
      container.innerHTML = `<div class="alert alert-danger">Erro: ${data.erro}</div>`;
    }

  } catch (error) {
    container.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'VALIDAR XML';
  }
});
</script>
{% endblock %}
