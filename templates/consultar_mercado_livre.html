<!-- templates/consultar_mercado_livre.html -->
{% extends 'base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consultar_mercado_livre.css') }}">
{% endblock %}

{% block content %}
<div class="mercado-livre-container">
    
    <!-- ========================================= -->
    <!-- CARD DE CONTROLES COMPACTOS (estilo AnyMarket) -->
    <!-- ========================================= -->
    <div class="controls-card">
        <!-- Linha 1: Busca e Status -->
        <div class="control-row">
            <div class="search-input">
                <input type="text" id="mlbs" placeholder="Digite os códigos MLB (separados por vírgula ou linha)" 
                       style="font-family: monospace;">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="buscarMLBs()">
                    <i class="fas fa-search"></i> Buscar
                </button>
                <button class="btn btn-outline-secondary" onclick="limparCampos()">
                    <i class="fas fa-broom"></i> Limpar
                </button>
            </div>
        </div>

        <!-- Linha 2: Filtros Básicos -->
        <div class="control-row">
            <div class="filter-group compact">
                <label>Tipo de Busca</label>
                <select class="filter-select" id="tipoBusca">
                    <option value="mlbs">Por MLBs</option>
                    <option value="meus_anuncios">Meus anúncios</option>
                </select>
            </div>
            
            <div class="filter-group compact">
                <label>Modo de Envio</label>
                <select class="filter-select" id="filtroEnvio">
                    <option value="todos">Todos</option>
                    <option value="me2">Apenas ME2</option>
                    <option value="me1">Apenas ME1</option>
                </select>
            </div>
            
            <div class="filter-group compact">
                <label>Manufacturing</label>
                <select class="filter-select" id="filtroManufacturing">
                    <option value="todos">Todos</option>
                    <option value="com">Com prazo</option>
                    <option value="sem">Sem prazo</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-outline-primary" onclick="analisarEnvioManufacturing()">
                    <i class="fas fa-shipping-fast"></i> Análise ME1/ME2
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SEÇÃO DE RESULTADOS -->
    <!-- ========================================= -->
    <div id="ordersContainer" class="orders-section hidden">
        <!-- Loading da Tabela -->
        <div id="tableLoading" class="table-loading hidden">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p>Buscando informações dos anúncios...</p>
            </div>
        </div>

        <!-- Tabela de Resultados -->
        <div class="table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>MLB</th>
                        <th>Título</th>
                        <th>Preço</th>
                        <th>Estoque</th>
                        <th>Envio</th>
                        <th>Prazo</th>
                        <th>Status</th>
                        <th>Frete</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Resultados serão inseridos aqui -->
                </tbody>
            </table>
        </div>

        <!-- Estatísticas Compactas -->
        <div id="stats" class="alert alert-info hidden" style="margin: 10px 0; padding: 8px 12px; font-size: 12px;">
            <!-- Estatísticas serão inseridas aqui -->
        </div>
    </div>

    <!-- Estado Vazio -->
    <div id="emptyState" class="empty-state">
        <i class="fas fa-store"></i>
        <h3>Nenhuma consulta realizada</h3>
        <p>Digite os códigos MLB e clique em "Buscar" para começar</p>
    </div>

    <!-- ========================================= -->
    <!-- RODAPÉ COM CONFIGURAÇÃO -->
    <!-- ========================================= -->
    <div class="auto-refresh-footer">
        <div class="auto-refresh-indicator">
            <i class="fas fa-key"></i>
            <span id="statusConfiguracao">Mercado Livre: </span>
            {% if esta_autenticado %}
                <span class="badge bg-success">Autenticado</span>
            {% else %}
                <span class="badge bg-danger">Não autenticado</span>
            {% endif %}
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleConfigSection()">
                <i class="fas fa-cog"></i> Configurar
            </button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE CONFIGURAÇÃO -->
<!-- ========================================= -->
<div id="configModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Configurar Mercado Livre</h2>
            <button class="close-modal" onclick="fecharConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="token-config">
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="clientId" placeholder="Seu Client ID" class="form-control">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="clientSecret" placeholder="Seu Client Secret" class="form-control">
                </div>
                <div class="form-group">
                    <label>Access Token</label>
                    <input type="text" id="accessToken" placeholder="Access Token" class="form-control">
                </div>
                <div class="form-group">
                    <label>Refresh Token</label>
                    <input type="text" id="refreshToken" placeholder="Refresh Token" class="form-control">
                </div>
                <div class="alert alert-info" style="font-size: 11px; padding: 8px;">
                    <i class="fas fa-info-circle"></i>
                    Obtenha estas credenciais em 
                    <a href="https://developers.mercadolibre.com.br/devcenter" target="_blank">Mercado Livre Developers</a>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="salvarConfiguracaoCompleta()">
                        <i class="fas fa-save"></i> Salvar Configuração
                    </button>
                    {% if esta_autenticado %}
                    <button class="btn btn-outline-danger" onclick="desautenticarMercadoLivre()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE DETALHES (mantido igual) -->
<!-- ========================================= -->
<div id="modalDetalhesMLB" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> Detalhes do Anúncio</h2>
            <button class="close-modal" onclick="fecharDetalhesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Conteúdo do modal de detalhes (mantido igual) -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Informações Básicas</h6>
                    <table class="table table-sm">
                        <tr><td><strong>MLB:</strong></td><td id="detalheMlb">-</td></tr>
                        <tr><td><strong>SKU:</strong></td><td id="detalheSku">-</td></tr>
                        <tr><td><strong>Status:</strong></td><td id="detalheStatus">-</td></tr>
                        <tr><td><strong>Tipo:</strong></td><td id="detalheTipo">-</td></tr>
                        <tr><td><strong>Catálogo:</strong></td><td id="detalheCatalogo">-</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Preço e Estoque</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Preço:</strong></td><td id="detalhePreco">-</td></tr>
                        <tr><td><strong>Estoque:</strong></td><td id="detalheEstoque">-</td></tr>
                        <tr><td><strong>Vendidos:</strong></td><td id="detalheVendidos">-</td></tr>
                        <tr><td><strong>Envio:</strong></td><td id="detalheEnvio">-</td></tr>
                        <tr><td><strong>Frete Grátis:</strong></td><td id="detalheFrete">-</td></tr>
                    </table>
                </div>
            </div>

            <div id="secaoVariacoes" style="display: none;">
                <h6><i class="fas fa-layer-group"></i> Variações</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID Variação</th>
                                <th>Atributos</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Vendidos</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVariacoes"></tbody>
                    </table>
                </div>
            </div>

            <div id="semVariacoes" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Este anúncio não possui variações.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharDetalhesModal()">Fechar</button>
            <a href="#" id="linkAnuncioML" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Abrir no Mercado Livre
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/consultar_mercado_livre.js') }}"></script>
{% endblock %}