<!-- templates/consultar_mercado_livre.html -->
{% extends 'base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consultar_mercado_livre.css') }}">
{% endblock %}

{% block content %}
<div class="mercado-livre-container">
    
    <!-- ========================================= -->
    <!-- BARRA DE BUSCA RÁPIDA -->
    <!-- ========================================= -->
    <div class="quick-search-bar">
        <div class="search-input-group">
            <input type="text" id="mlbs" placeholder="Digite os códigos MLB (separados por vírgula ou linha)" 
                   style="font-family: monospace;">
            <div class="search-buttons">
                <button class="btn btn-primary" onclick="buscarMLBs()">
                    <i class="fas fa-search"></i> Buscar
                </button>
                <!--<button class="btn btn-outline-primary" onclick="analisarEnvioManufacturing()">
                    <i class="fas fa-shipping-fast"></i> Análise
                </button> -->
                <button class="btn btn-success" onclick="exportarParaExcel()" id="btnExportar" style="display: none;">
                    <i class="fas fa-file-excel"></i> Exportar
                </button>
            </div>
        </div>
        
        <!-- Filtros Ativos -->
        <div class="active-filters" id="activeFilters" style="display: none;">
            <!-- Filtros ativos aparecerão aqui -->
        </div>
    </div>
    
    <!-- ========================================= -->
    <!-- HEADER DE FILTROS COMPACTOS -->
    <!-- ========================================= -->
            <div class="filters-header" id="filtersHeader">
            <!-- ÁREA QUE RECOLHE/EXPANDE -->
            <div class="filters-content" id="filtersContent">
                <div class="filters-grid">
                    <!-- Linha 1: Filtros principais -->
                    <div class="filter-group">
                        <label>TIPO DE BUSCA</label>
                        <select class="filter-select" id="tipoBusca">
                            <option value="mlbs">MLB</option>
                            <option value="meus_anuncios">SKU</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>TIPO DE ENVIO</label>
                        <select class="filter-select" id="filtroEnvio">
                            <option value="todos">Todos</option>
                            <option value="me2">ME2</option>
                            <option value="me1">ME1</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>DISPONIBILIDADE</label>
                        <select class="filter-select" id="filtroManufacturing">
                            <option value="todos">Todos</option>
                            <option value="com">Com prazo</option>
                            <option value="sem">Sem prazo</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>SITUAÇÃO</label>
                        <select class="filter-select" id="filtroStatus">
                            <option value="todos">Todos</option>
                            <option value="active">Ativo</option>
                            <option value="paused">Pausado</option>
                            <option value="closed">Fechado</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- LINHA DE AÇÕES (NÃO RECOLHE) -->
            <div class="filter-actions">
                <button class="btn btn-outline-success" onclick="atualizarManufacturingEmMassa()">
                    <i class="fas fa-clock"></i> Atualizar Lote
                </button>
                <button class="btn btn-outline-info" onclick="abrirModalPlanilha()">
                    <i class="fas fa-file-excel"></i> Via Planilha
                </button>
                <button class="btn btn-outline-secondary" onclick="limparCampos()">
                    <i class="fas fa-broom"></i> Limpar
                </button>
                <button class="btn btn-outline-warning" onclick="aplicarFiltros()">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
                
                <!-- BOTÃO TOGGLE (SEMPRE VISÍVEL) -->
                <button class="toggle-filters-btn" id="toggleFiltersBtn">
                    <i class="fas fa-chevron-up"></i>
                    <span id="toggleText">Recolher Filtros</span>
                </button>
            </div>
        </div>
    
    <!-- ========================================= -->
    <!-- SEÇÃO DE RESULTADOS (mantida igual) -->
    <!-- ========================================= -->
    <div id="ordersContainer" class="orders-section hidden"> <!-- Começa hidden -->
    <!-- Loading da Tabela - Começa hidden -->
    <div id="tableLoading" class="table-loading hidden">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p>Buscando informações dos anúncios...</p>
        </div>
    </div>

        <!-- Tabela de Resultados -->
        <div class="table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>MLB</th>
                        <th>Título</th>
                        <th>Preço</th>
                        <th>Estoque</th>
                        <th>Envio</th>
                        <th>Prazo</th>
                        <th>Status</th>
                        <th>Frete</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Resultados serão inseridos aqui -->
                </tbody>
            </table>
        </div>

        <!-- Estatísticas Compactas -->
        <div id="stats" class="alert alert-info hidden" style="margin: 10px 0; padding: 8px 12px; font-size: 12px;">
            <!-- Estatísticas serão inseridas aqui -->
        </div>
    </div>

    <!-- Estado Vazio -->
    <div id="emptyState" class="empty-state">
        <i class="fas fa-store"></i>
        <h3>Nenhuma consulta realizada</h3>
        <p>Digite os códigos MLB e clique em "Buscar" para começar</p>
    </div>

    <!-- ========================================= -->
    <!-- RODAPÉ COM CONFIGURAÇÃO -->
    <!-- ========================================= -->
    <div class="auto-refresh-footer">
        <div class="auto-refresh-indicator">
            <i class="fas fa-key"></i>
            <span id="statusConfiguracao">Mercado Livre: </span>
            {% if esta_autenticado %}
                <span class="badge bg-success">Autenticado</span>
            {% else %}
                <span class="badge bg-danger">Não autenticado</span>
            {% endif %}
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleConfigSection()">
                <i class="fas fa-cog"></i> Configurar
            </button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE CONFIGURAÇÃO -->
<!-- ========================================= -->
<div id="configModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Configurar Mercado Livre</h2>
            <button class="close-modal" onclick="fecharConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="token-config">
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="clientId" placeholder="Seu Client ID" class="form-control">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="clientSecret" placeholder="Seu Client Secret" class="form-control">
                </div>
                <div class="form-group">
                    <label>Access Token</label>
                    <input type="text" id="accessToken" placeholder="Access Token" class="form-control">
                </div>
                <div class="form-group">
                    <label>Refresh Token</label>
                    <input type="text" id="refreshToken" placeholder="Refresh Token" class="form-control">
                </div>
                <div class="alert alert-info" style="font-size: 11px; padding: 8px;">
                    <i class="fas fa-info-circle"></i>
                    Obtenha estas credenciais em 
                    <a href="https://developers.mercadolibre.com.br/devcenter" target="_blank">Mercado Livre Developers</a>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="salvarConfiguracaoCompleta()">
                        <i class="fas fa-save"></i> Salvar Configuração
                    </button>
                    {% if esta_autenticado %}
                    <button class="btn btn-outline-danger" onclick="desautenticarMercadoLivre()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE DETALHES (mantido igual) -->
<!-- ========================================= -->
<div id="modalDetalhesMLB" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> Detalhes do Anúncio</h2>
            <button class="close-modal" onclick="fecharDetalhesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Conteúdo do modal de detalhes (mantido igual) -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Informações Básicas</h6>
                    <table class="table table-sm">
                        <tr><td><strong>MLB:</strong></td><td id="detalheMlb">-</td></tr>
                        <tr><td><strong>SKU:</strong></td><td id="detalheSku">-</td></tr>
                        <tr><td><strong>Status:</strong></td><td id="detalheStatus">-</td></tr>
                        <tr><td><strong>Tipo:</strong></td><td id="detalheTipo">-</td></tr>
                        <tr><td><strong>Catálogo:</strong></td><td id="detalheCatalogo">-</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Preço e Estoque</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Preço:</strong></td><td id="detalhePreco">-</td></tr>
                        <tr><td><strong>Estoque:</strong></td><td id="detalheEstoque">-</td></tr>
                        <tr><td><strong>Vendidos:</strong></td><td id="detalheVendidos">-</td></tr>
                        <tr><td><strong>Envio:</strong></td><td id="detalheEnvio">-</td></tr>
                        <tr><td><strong>Frete Grátis:</strong></td><td id="detalheFrete">-</td></tr>
                    </table>
                </div>
            </div>

            <div id="secaoVariacoes" style="display: none;">
                <h6><i class="fas fa-layer-group"></i> Variações</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID Variação</th>
                                <th>Atributos</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Vendidos</th>
                                <th>Prazo</th> <!-- NOVA COLUNA -->
                                <th>SKU</th> <!-- NOVA COLUNA -->
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVariacoes"></tbody>
                    </table>
                </div>
            </div>

            <div id="semVariacoes" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Este anúncio não possui variações.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharDetalhesModal()">Fechar</button>
            <a href="#" id="linkAnuncioML" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Abrir no Mercado Livre
            </a>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE ATUALIZAÇÃO DE MANUFACTURING -->
<!-- ========================================= -->
<div id="modalManufacturing" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2><i class="fas fa-clock"></i> Atualizar Prazo</h2>
            <button class="close-modal" onclick="fecharManufacturingModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>MLB</label>
                <input type="text" id="manufacturingMlb" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Prazo de Disponibilidade (dias)</label>
                <select id="manufacturingDias" class="form-control">
                    <option value="1">1 dia</option>
                    <option value="2">2 dias</option>
                    <option value="3">3 dias</option>
                    <option value="5">5 dias</option>
                    <option value="7">7 dias</option>
                    <option value="10">10 dias</option>
                    <option value="15">15 dias</option>
                    <option value="20">20 dias</option>
                    <option value="25">25 dias</option>
                    <option value="30">30 dias</option>
                    <option value="0">Remover prazo</option>
                </select>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                O prazo será exibido como "Prazo de disponibilidade: X dias" no anúncio.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharManufacturingModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarAtualizacaoManufacturing()">
                <i class="fas fa-save"></i> Atualizar Prazo
            </button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE PROGRESSO DE ATUALIZAÇÃO -->
<!-- ========================================= -->
<div id="modalProgresso" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-sync-alt fa-spin"></i> Atualizando MLBs</h2>
            <button class="close-modal" onclick="fecharModalProgresso()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="progress-container">
                <!-- Barra de Progresso -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                
                <!-- Informações de Progresso -->
                <div class="progress-info">
                    <div class="progress-stats">
                        <span id="progressText">0% (0/0)</span>
                        <span id="progressSpeed" class="progress-speed"></span>
                    </div>
                    
                    <!-- Detalhes do Processamento -->
                    <div class="progress-details">
                        <div class="detail-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Sucesso: </span>
                            <strong id="progressSucesso">0</strong>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-times-circle text-danger"></i>
                            <span>Erros: </span>
                            <strong id="progressErros">0</strong>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock text-warning"></i>
                            <span>Restantes: </span>
                            <strong id="progressRestantes">0</strong>
                        </div>
                    </div>
                    
                    <!-- MLB Atual sendo Processado -->
                    <div class="current-processing">
                        <small>Processando: </small>
                        <code id="currentMlb">-</code>
                        <span id="currentStatus" class="status-badge status-processing">Aguardando...</span>
                    </div>
                    
                    <!-- Log de Atividades -->
                    <div class="activity-log" id="activityLog">
                        <!-- Logs serão adicionados aqui -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cancelarAtualizacao()" id="btnCancelar">
                <i class="fas fa-stop"></i> Cancelar
            </button>
            <button class="btn btn-success" onclick="fecharModalProgresso()" id="btnConcluir" style="display: none;">
                <i class="fas fa-check"></i> Concluir
            </button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- MODAL DE UPLOAD DE PLANILHA -->
<!-- ========================================= -->
<div id="modalPlanilha" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2><i class="fas fa-file-excel"></i> Atualizar via Planilha</h2>
            <button class="close-modal" onclick="fecharModalPlanilha()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-section">
                <div class="form-group">
                    <label>Selecionar arquivo Excel/CSV</label>
                    <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv" class="form-control">
                    <small class="text-muted">Formatos suportados: Excel (.xlsx, .xls) e CSV (.csv)</small>
                </div>
                
                <div class="template-section">
                    <h4><i class="fas fa-download"></i> Baixar Modelo</h4>
                    <p>Use este modelo para preparar sua planilha:</p>
                    <button class="btn btn-outline-primary" onclick="baixarModeloPlanilha()">
                        <i class="fas fa-download"></i> Baixar Modelo Excel
                    </button>
                </div>
                
                <div class="instructions">
                    <h4><i class="fas fa-info-circle"></i> Instruções:</h4>
                    <ul>
                        <li>A planilha deve ter as colunas <strong>MLB</strong> e <strong>DIAS</strong></li>
                        <li><strong>MLB</strong>: Código do anúncio (ex: MLB1234567890)</li>
                        <li><strong>DIAS</strong>: Prazo em dias (ex: 5, 10, 15)</li>
                        <li>Use 0 em DIAS para remover o prazo</li>
                        <li><strong>Sem limites</strong> - Processamos qualquer quantidade de MLBs</li>
                        <li>Para grandes volumes (>500), o processo pode levar alguns minutos</li>
                    </ul>
                </div>
                
                <!-- Pré-visualização da Planilha -->
                <div id="previewSection" style="display: none;">
                    <h4><i class="fas fa-table"></i> Pré-visualização</h4>
                    <div class="table-preview">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>MLB</th>
                                    <th>DIAS</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- Dados da planilha serão mostrados aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="preview-stats">
                        <strong>Total: <span id="previewTotal">0</span> MLBs encontrados</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharModalPlanilha()">Cancelar</button>
            <button class="btn btn-primary" onclick="processarPlanilha()" id="btnProcessarPlanilha" disabled>
                <i class="fas fa-play"></i> Iniciar Atualização
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/consultar_mercado_livre.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %}