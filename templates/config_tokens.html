{% extends 'base.html' %}
{% block title %}Configura√ß√µes - Tokens API{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/config_tokens.css') }}">
{% endblock %}

{% block content %}
<div class="tokens-container">
    <!-- CONTAINER PRINCIPAL -->
    <div class="settings-layout">
        <!-- SIDEBAR COM SERVI√áOS -->
        <div class="settings-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-plug"></i> Servi√ßos</h3>
            </div>
            <div class="services-menu">
                <div class="service-menu-item active" data-target="ml-section">
                    <div class="service-icon">
                        <i class="fab fa-shopify"></i>
                    </div>
                    <div class="service-info">
                        <h4>Mercado Livre</h4>
                        <p>Multi-contas</p>
                    </div>
                    <div class="service-status">
                        <span class="status-indicator connected"></span>
                    </div>
                </div>

                <div class="service-menu-item" data-target="anymarket-section">
                    <div class="service-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="service-info">
                        <h4>AnyMarket</h4>
                        <p>Pedidos e produtos</p>
                    </div>
                    <div class="service-status">
                        <span class="status-indicator {% if token_configurado %}connected{% else %}disconnected{% endif %}"></span>
                    </div>
                </div>

                <div class="service-menu-item" data-target="sheets-section">
                    <div class="service-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="service-info">
                        <h4>Google Sheets</h4>
                        <p>Planilhas e dados</p>
                    </div>
                    <div class="service-status">
                        <span class="status-indicator connected"></span>
                    </div>
                </div>
            </div>

            <!-- STATUS GERAL -->
            <div class="sidebar-status">
                <h4><i class="fas fa-heartbeat"></i> Status Geral</h4>
                <div class="status-list">
                    <div class="status-item">
                        <span class="status-label">Mercado Livre</span>
                        <span class="status-value" id="mlGlobalStatus">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">AnyMarket</span>
                        <span class="status-value" id="anymarketGlobalStatus">{% if token_configurado %}Conectado{% else %}Pendente{% endif %}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Google Sheets</span>
                        <span class="status-value" id="sheetsGlobalStatus">Conectado</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTE√öDO PRINCIPAL -->
        <div class="settings-content">
            <!-- SE√á√ÉO MERCADO LIVRE -->
            <div class="settings-section active" id="ml-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fab fa-shopify"></i>
                        <h2>Mercado Livre</h2>
                    </div>
                    <div class="section-badge">
                        <span class="badge badge-multi">Multi-contas</span>
                    </div>
                </div>

                <div class="section-description">
                    <p>Gerencie m√∫ltiplas contas do Mercado Livre. Adicione novas contas com App ID e Secret Key.</p>
                </div>

                <!-- RESUMO R√ÅPIDO -->
                <div class="quick-summary">
                    <div class="summary-item">
                        <i class="fas fa-store"></i>
                        <div>
                            <h4>Conta Atual</h4>
                            <p id="currentAccountName">Carregando...</p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-key"></i>
                        <div>
                            <h4>Status</h4>
                            <p id="currentAccountStatus">Verificando...</p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <i class="fas fa-users"></i>
                        <div>
                            <h4>Contas Totais</h4>
                            <p id="totalAccountsCount">Carregando...</p>
                        </div>
                    </div>
                </div>

                <!-- BOT√ÉO PRINCIPAL -->
                <div class="primary-action">
                    <button class="btn-primary" onclick="abrirModalNovaConta()">
                        <i class="fas fa-plus"></i> Adicionar Nova Conta
                    </button>
                </div>

                <!-- LISTA DE CONTAS (S√ì APARECE SE TIVER CONTAS) -->
                <div class="accounts-section" id="mlAccountsContainer">
                    <h4><i class="fas fa-list"></i> Contas Configuradas</h4>
                    <div class="accounts-grid" id="mlAccountsList">
                        <!-- Contas ser√£o carregadas aqui -->
                    </div>
                </div>

                <!-- A√á√ïES R√ÅPIDAS -->
                <div class="quick-actions">
                    <button class="btn-secondary" onclick="testarTodasContas()">
                        <i class="fas fa-vial"></i> Testar Todas as Contas
                    </button>
                    <button class="btn-secondary" onclick="carregarContasMercadoLivre()">
                        <i class="fas fa-sync"></i> Atualizar Lista
                    </button>
                </div>
            </div>

            <!-- SE√á√ÉO ANYMARKET -->
            <div class="settings-section" id="anymarket-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-shopping-cart"></i>
                        <h2>AnyMarket</h2>
                    </div>
                    <div class="section-badge">
                        <span class="badge {% if token_configurado %}badge-success{% else %}badge-warning{% endif %}">
                            {% if token_configurado %}Configurado{% else %}Pendente{% endif %}
                        </span>
                    </div>
                </div>

                <div class="section-description">
                    <p>Configure o token de acesso para integra√ß√£o com a API de pedidos do AnyMarket.</p>
                </div>

                <!-- FORMUL√ÅRIO SIMPLES -->
                <div class="simple-form">
                    <div class="form-group">
                        <label for="anymarket_token">
                            <i class="fas fa-key"></i> Token de Acesso
                        </label>
                        <div class="input-with-action">
                            <input type="password" 
                                   id="anymarket_token" 
                                   class="form-control"
                                   placeholder="{% if token_configurado %}Token configurado{% else %}Cole seu GumgaToken aqui...{% endif %}">
                            <button type="button" class="btn-eye" onclick="toggleTokenVisibility('anymarket_token')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="form-help">
                            Token necess√°rio para acessar a API de pedidos do AnyMarket
                        </small>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" onclick="salvarToken('anymarket')">
                            <i class="fas fa-save"></i> Salvar Token
                        </button>
                        <button class="btn-secondary" onclick="testarToken('anymarket')">
                            <i class="fas fa-vial"></i> Testar Conex√£o
                        </button>
                        {% if token_configurado %}
                        <button class="btn-danger" onclick="removerToken('anymarket')">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                        {% endif %}
                    </div>

                    <div id="anymarketStatus" class="status-message"></div>
                </div>
            </div>

            <!-- SE√á√ÉO GOOGLE SHEETS -->
            <div class="settings-section" id="sheets-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-table"></i>
                        <h2>Google Sheets</h2>
                    </div>
                    <div class="section-badge">
                        <span class="badge badge-success">Conectado</span>
                    </div>
                </div>

                <div class="section-description">
                    <p>Configure a conex√£o com Google Sheets para importa√ß√£o e exporta√ß√£o de dados.</p>
                </div>

                <!-- CONFIGURA√á√ÉO -->
                <div class="simple-form">
                    <div class="form-group">
                        <label>
                            <i class="fas fa-credential"></i> Credenciais
                        </label>
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            As credenciais s√£o gerenciadas via arquivo <code>credentials.json</code>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sheet_id">
                            <i class="fas fa-id-card"></i> ID da Planilha Padr√£o
                        </label>
                        <input type="text" 
                               id="sheet_id" 
                               class="form-control"
                               value="{{ config.sheet_id }}" 
                               placeholder="Ex: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <small class="form-help">
                            Encontre no URL: .../spreadsheets/d/<strong>[ID]</strong>/edit
                        </small>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" onclick="salvarConfigGoogleSheets()">
                            <i class="fas fa-save"></i> Salvar Configura√ß√£o
                        </button>
                        <button class="btn-secondary" onclick="testarGoogleSheets()">
                            <i class="fas fa-vial"></i> Testar Conex√£o
                        </button>
                    </div>

                    <div id="googleSheetsStatus" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS (MANTIDOS) -->
<!-- Modal Nova Conta Mercado Livre -->
<div id="modalNovaConta" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Nova Conta Mercado Livre</h3>
            <button class="close-modal" onclick="fecharModalNovaConta()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-box">
                <i class="fas fa-magic"></i>
                <div>
                    <strong>Autentica√ß√£o Autom√°tica</strong>
                    <p>O sistema tentar√° obter tokens automaticamente!</p>
                </div>
            </div>
            
            <form id="formNovaConta">
                <div class="form-group">
                    <label>Nome da Conta</label>
                    <input type="text" id="novaContaNome" class="form-control" 
                           placeholder="Ex: Minha Loja Principal" required>
                    <small>Um nome para identificar esta conta</small>
                </div>
                
                <div class="form-group">
                    <label>App ID (Client ID)</label>
                    <input type="text" id="novaContaAppId" class="form-control" 
                           placeholder="Seu App ID do Mercado Livre" required>
                    <small>Encontre em: Developers > Minhas aplica√ß√µes</small>
                </div>
                
                <div class="form-group">
                    <label>Secret Key (Client Secret)</label>
                    <input type="password" id="novaContaSecretKey" class="form-control" 
                           placeholder="Sua Secret Key" required>
                    <small>Mantenha em segredo</small>
                </div>
            </form>
            
            <div id="novaContaResultado" class="result-message"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="fecharModalNovaConta()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-primary" onclick="adicionarNovaContaML()">
                <i class="fas fa-magic"></i> Adicionar e Autenticar
            </button>
        </div>
    </div>
</div>

<!-- Modal Adicionar Tokens Manualmente -->
<div id="modalAdicionarTokens" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Completar Autentica√ß√£o</h3>
            <button class="close-modal" onclick="fecharModalTokens()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalTokensInfo">
                <!-- Instru√ß√µes via JS -->
            </div>
            
            <div class="form-group">
                <label>Access Token</label>
                <input type="text" id="manualAccessToken" class="form-control" 
                       placeholder="APP_USR-..." style="font-family: monospace;">
            </div>
            
            <div class="form-group">
                <label>Refresh Token</label>
                <input type="text" id="manualRefreshToken" class="form-control" 
                       placeholder="TG-..." style="font-family: monospace;">
            </div>
            
            <div id="modalTokensResultado" class="result-message"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="fecharModalTokens()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-primary" onclick="salvarTokensManualmente()">
                <i class="fas fa-save"></i> Salvar Tokens
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/config_tokens.js') }}"></script>
<script src="{{ url_for('static', filename='js/mercadolivre_accounts.js') }}"></script>

<script>
// Navega√ß√£o entre se√ß√µes
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Inicializando navega√ß√£o entre se√ß√µes...');
    
    // Configura navega√ß√£o do sidebar
    const menuItems = document.querySelectorAll('.service-menu-item');
    const sections = document.querySelectorAll('.settings-section');
    
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            console.log('üìå Clicou no menu:', targetId);
            
            // Remove classe active de todos os menus
            menuItems.forEach(i => {
                i.classList.remove('active');
            });
            
            // Remove classe active de todas as se√ß√µes
            sections.forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none'; // Esconde completamente
            });
            
            // Adiciona classe active no menu selecionado
            this.classList.add('active');
            
            // Mostra a se√ß√£o correspondente
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block'; // Mostra a se√ß√£o
                console.log('‚úÖ Mostrando se√ß√£o:', targetId);
                
                // Carrega dados espec√≠ficos da se√ß√£o se necess√°rio
                if (targetId === 'ml-section') {
                    console.log('üîÑ Carregando dados Mercado Livre...');
                    carregarContasMercadoLivre();
                } else if (targetId === 'anymarket-section') {
                    console.log('üîÑ Verificando token AnyMarket...');
                    verificarTokenConfigurado();
                }
            }
        });
    });
    
    // Garante que apenas a primeira se√ß√£o esteja vis√≠vel inicialmente
    sections.forEach((section, index) => {
        if (index === 0) {
            section.classList.add('active');
            section.style.display = 'block';
        } else {
            section.classList.remove('active');
            section.style.display = 'none';
        }
    });
    
    // Carrega dados iniciais do Mercado Livre
    if (document.getElementById('ml-section').classList.contains('active')) {
        console.log('üîÑ Carregando dados iniciais Mercado Livre...');
        carregarContasMercadoLivre();
    }
});

// Fun√ß√£o para mostrar uma se√ß√£o espec√≠fica
function mostrarSecao(secaoId) {
    const sections = document.querySelectorAll('.settings-section');
    const menuItems = document.querySelectorAll('.service-menu-item');
    
    // Esconde todas as se√ß√µes
    sections.forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
    });
    
    // Remove active de todos os menus
    menuItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Mostra a se√ß√£o desejada
    const secao = document.getElementById(secaoId);
    if (secao) {
        secao.classList.add('active');
        secao.style.display = 'block';
        
        // Ativa o menu correspondente
        const menuItem = document.querySelector(`[data-target="${secaoId}"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }
        
        // Carrega dados se necess√°rio
        if (secaoId === 'ml-section') {
            carregarContasMercadoLivre();
        } else if (secaoId === 'anymarket-section') {
            verificarTokenConfigurado();
        }
    }
}

// Fun√ß√µes auxiliares
function testarTodasContas() {
    alert('Fun√ß√£o para testar todas as contas ser√° implementada');
}

function removerToken(service) {
    if (confirm('Tem certeza que deseja remover o token?')) {
        if (service === 'anymarket') {
            fetch('/api/tokens/anymarket/remover', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    }
}

// Atualiza status global
function atualizarStatusGlobal() {
    console.log('Atualizando status global...');
    // Implemente atualiza√ß√£o de status
}
</script>
{% endblock %}
