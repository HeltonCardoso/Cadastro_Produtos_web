{% extends 'base.html' %}
{% block title %}Pedidos - AnyMarket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pedidos_anymarket.css') }}">
{% endblock %}

{% block content %}
<div class="pedidos-container">
    <!-- Header -->
    <div class="pedidos-header">
        <h1><i class="fas fa-shopping-cart me-2"></i>Gestão de Pedidos - AnyMarket</h1>
    </div>

    <!-- Conteúdo com scroll -->
    <div class="pedidos-content">
        <!-- Controles SIMPLIFICADOS -->
        <div class="controls-card">
            <!-- Token oculto com configuração -->
            <div class="token-section" style="display: none;" id="tokenSection">
                <div class="token-input">
                    <label>Token de Acesso</label>
                    <input type="password" id="tokenInput" placeholder="Cole seu GumgaToken aqui..." 
                           value="">
                </div>
            </div>

            <!-- Busca Rápida -->
            <div class="quick-search">
                <div class="search-input">
                    <input type="text" id="searchInput" placeholder="Buscar por ID, cliente, SKU..." 
                           onkeyup="filtrarPedidos(this.value)">
                </div>
                <button class="btn btn-primary" onclick="carregarPedidos(1)">
                    <i class="fas fa-search"></i> Buscar Pedidos
                </button>
                <button class="btn btn-outline" onclick="toggleTokenSection()">
                    <i class="fas fa-cog"></i> Configurar Token
                </button>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos os status</option>
                        <option value="PENDING">Pendente</option>
                        <option value="PAID_WAITING_SHIP">Pago - Aguardando Envio</option>
                        <option value="INVOICED">Faturado</option>
                        <option value="SHIPPED">Enviado</option>
                        <option value="DELIVERED">Entregue</option>
                        <option value="CONCLUDED">Concluído</option>
                        <option value="CANCELED">Cancelado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Marketplace</label>
                    <select id="marketplaceFilter" class="filter-select">
                        <option value="">Todos marketplaces</option>
                        <option value="MERCADO_LIVRE">Mercado Livre</option>
                        <option value="SHOPEE">Shopee</option>
                        <option value="MAGAZINE_LUIZA">Magazine Luiza</option>
                        <option value="MADEIRA_MADEIRA">Madeira Madeira</option>
                        <option value="MOBLY">Mobly</option>
                        <option value="LEROY_MERLIN">Leroy Merlin</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Data Início</label>
                    <input type="date" id="dataInicio" class="date-input" 
                        value="${new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0]}">
                </div>
                
                <div class="filter-group">
                    <label>Data Fim</label>
                    <input type="date" id="dataFim" class="date-input" 
                        value="${new Date().toISOString().split('T')[0]}">
                </div>
            </div>

            <div class="actions-row">
                <div>
                        <button class="btn btn-outline" onclick="limparFiltros()">
                            <i class="fas fa-eraser"></i> Limpar Filtros
                        </button>
                        <button class="btn btn-outline" onclick="exportarPedidos()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="carregarTodosPedidos()">
                            <i class="fas fa-sync"></i> Carregar Todos
                        </button>
                        <button class="btn btn-primary" onclick="buscarComFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
        </div>

        <!-- Mensagens -->
        <div id="loading" class="loading hidden"></div>
        <div id="errorMessage" class="alert alert-error hidden"></div>
        <div id="infoMessage" class="alert alert-success hidden"></div>
        <div id="stats" class="alert alert-info hidden"></div>

        <!-- Tabela de Pedidos -->
        <div id="ordersContainer" class="orders-section hidden">
            <div class="table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Marketplace</th>
                            <th>Status</th>
                            <th>Nº Marketplace</th>
                            <th>Comprador</th>
                            <th>Data Criação</th>
                            <th>Itens</th>
                            <th>Valor Total</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Pedidos serão inseridos aqui via JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Paginação -->
            <div class="pagination">
                <!-- Paginação será inserida aqui via JavaScript -->
            </div>
        </div>

        <!-- Estado Vazio -->
        <div id="emptyState" class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <h3>Nenhum pedido carregado</h3>
            <p>Configure os filtros e clique em "Buscar Pedidos" para começar</p>
            <button class="btn btn-primary mt-3" onclick="toggleTokenSection()">
                <i class="fas fa-cog"></i> Configurar Token Primeiro
            </button>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <div id="modalContent"></div>
    </div>
</div>

<!-- Modal de Configuração do Token -->
<div id="tokenModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Configurar Token</h2>
            <button class="close-modal" onclick="fecharTokenModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="token-config">
                <div class="form-group">
                    <label>Token de Acesso AnyMarket</label>
                    <input type="password" id="tokenConfigInput" 
                           placeholder="Cole seu GumgaToken aqui..." class="form-control">
                    <small class="text-muted">O token é necessário para acessar a API do AnyMarket</small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="salvarToken()">
                        <i class="fas fa-save"></i> Salvar Token
                    </button>
                    <button class="btn btn-outline" onclick="fecharTokenModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pedidos_anymarket.js') }}"></script>
{% endblock %}