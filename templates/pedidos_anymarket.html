{% extends 'base.html' %}
{% block title %}Pedidos - AnyMarket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pedidos_anymarket.css') }}">
{% endblock %}

{% block content %}
<div class="pedidos-container">
    <!-- Header -->
    <div class="pedidos-header">
        <h1><i class="fas fa-shopping-cart me-2"></i>Gestão de Pedidos - AnyMarket</h1>
    </div>

    <!-- Conteúdo com scroll -->
    <div class="pedidos-content">
        <!-- Controles COMPACTOS -->
        <div class="controls-card">
            <!-- Linha 1: Busca e Ações Principais -->
            <div class="control-row">
                <div class="search-input">
                    <input type="text" id="searchInput" placeholder="Buscar por ID, cliente, SKU..." 
                           onkeyup="filtrarPedidos(this.value)">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="carregarPedidos(1)">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="toggleTokenSection()">
                        <i class="fas fa-cog"></i> Token
                    </button>
                </div>
            </div>

            <!-- Linha 2: Filtros Básicos -->
            <div class="control-row">
                <div class="filter-group compact">
                    <label>Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="PENDING">Pendente</option>
                        <option value="DELIVERY_ISSUE">Excessão Entrega</option>
                        <option value="PAID_WAITING_SHIP">Pago</option>
                        <option value="INVOICED">Faturado</option>
                        <option value="PAID_WAITING_DELIVERY">Enviado</option>
                        <option value="CONCLUDED">Concluido</option>
                        <option value="CANCELED">Cancelado</option>
                    </select>
                </div>
                
                <div class="filter-group compact">
                    <label>Marketplace</label>
                    <select id="marketplaceFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="MERCADO_LIVRE">Mercado Livre</option>
                        <option value="SHOPEE">Shopee</option>
                        <option value="MAGAZINE_LUIZA">Magazine Luiza</option>
                        <option value="MADEIRA_MADEIRA">Madeira Madeira</option>
                        <option value="MOBLY">Mobly</option>
                        <option value="LEROY_MERLIN">Leroy MerliN</option>
                        <option value="WEB_CONTINENTAL_V2">Web Contintental</option>
                    </select>
                </div>
                
                <div class="filter-group compact">
                    <label>De</label>
                    <input type="date" id="createdAfter" class="date-input">
                </div>
                
                <div class="filter-group compact">
                    <label>Até</label>
                    <input type="date" id="createdBefore" class="date-input">
                </div>
            </div>

            <!-- Linha 3: Ordenação e Ações -->
            <div class="control-row">
                <div class="filter-group compact">
                    <label>Ordenar por</label>
                    <select id="sortField" class="filter-select">
                        <option value="createdAt">Data</option>
                        <option value="paymentDate">Pagamento</option>
                        <option value="total">Valor</option>
                    </select>
                </div>
                
                <div class="filter-group compact">
                    <label>Ordem</label>
                    <select id="sortDirection" class="filter-select">
                        <option value="DESC">↓ Recentes</option>
                        <option value="ASC">↑ Antigos</option>
                    </select>
                </div>
                
                <button class="btn btn-outline-primary compact-btn" onclick="aplicarOrdenacao()">
                    <i class="fas fa-sort"></i> Aplicar Filtro
                </button>

                <div class="action-buttons">
                    <button class="btn btn-outline-danger compact-btn" onclick="limparFiltros()">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                    <button class="btn btn-success compact-btn" onclick="exportarPedidos()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Mensagens -->
        <!--<div id="loading" class="loading hidden"></div> -->
        <div id="errorMessage" class="alert alert-error hidden"></div>
        <div id="stats" class="alert alert-info hidden"></div>

        <!-- Tabela de Pedidos -->
        <div id="ordersContainer" class="orders-section hidden">
            <div class="table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Marketplace</th>
                            <th>Status</th>
                            <th>Nº</th>
                            <th>Comprador</th>
                            <th>Data</th>
                            <th>Itens</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                        <div class="table-container">
                            <table class="orders-table">
                                <thead>...</thead>
                                <tbody id="ordersTableBody">...</tbody>
                            </table>
                            <div id="tableLoading" class="table-loading hidden">
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p>Carregando pedidos...</p>
                                </div>
                            </div>
                        </div>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Pedidos serão inseridos aqui via JavaScript -->
                    </tbody>
                </table>
                <div id="tableLoading" class="table-loading hidden">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p>Carregando pedidos...</p>
            </div>
        </div>
            </div>
            
            <!-- Paginação -->
            <div class="pagination">
                <!-- Paginação será inserida aqui via JavaScript -->
            </div>
        </div>

        <!-- Estado Vazio -->
        <div id="emptyState" class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <h3>Nenhum pedido carregado</h3>
            <p>Configure os filtros e clique em "Buscar" para começar</p>
            <button class="btn btn-primary mt-3" onclick="toggleTokenSection()">
                <i class="fas fa-cog"></i> Configurar Token
            </button>
        </div>
        <div id="autoRefreshFooter" class="auto-refresh-footer">
    <div class="auto-refresh-indicator">
        <i class="fas fa-sync-alt"></i>
        Última atualização: --
        <span class="refresh-badge">Auto</span>
    </div>
</div>
    </div>
</div>

<!-- Modais (manter igual) -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <div id="modalContent"></div>
    </div>
</div>

<div id="tokenModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Configurar Token</h2>
            <button class="close-modal" onclick="fecharTokenModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="token-config">
                <div class="form-group">
                    <label>Token de Acesso AnyMarket</label>
                    <input type="password" id="tokenConfigInput" 
                           placeholder="Cole seu GumgaToken aqui..." class="form-control">
                    <small class="text-muted">O token é necessário para acessar a API do AnyMarket</small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="salvarToken()">
                        <i class="fas fa-save"></i> Salvar Token
                    </button>
                    <button class="btn btn-outline" onclick="fecharTokenModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pedidos_anymarket.js') }}"></script>
{% endblock %}